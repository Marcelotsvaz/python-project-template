stages:
  - build
  - test
  - release


variables:
    PIP_ROOT_USER_ACTION: ignore  # Ignore pip warning when running as root.


default:
    image: python:3.11.6-alpine3.18
    
    interruptible: true
    
    before_script:
      - apk add --no-cache git
      - pip install --no-cache-dir pdm
      - pdm install --plugins



# 
# Build jobs.
#---------------------------------------------------------------------------------------------------
package:
    stage: build
    
    script:
      - pdm build
    
    artifacts:
        paths:
          - .staging/dist/



# 
# Test jobs.
#---------------------------------------------------------------------------------------------------
test:
    stage: test
    
    script:
      - pdm sync
      - pdm test
    
    coverage: /^TOTAL.+?(\d+(?:\.\d+)?\%)$/
    
    artifacts:
        reports:
            coverage_report:
                coverage_format: cobertura
                path: .staging/coverage.xml



# 
# Release jobs.
#---------------------------------------------------------------------------------------------------
.release:
    stage: release
    
    rules:
      - if: $CI_COMMIT_TAG


package:gitlab:
    extends: .release
    
    variables:
        PDM_PUBLISH_REPO: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi
        PDM_PUBLISH_USERNAME: gitlab-ci-token
        PDM_PUBLISH_PASSWORD: ${CI_JOB_TOKEN}
    
    script:
      - pdm publish --no-build


package:pypi:
    extends: .release
    
    script:
      - pdm publish --no-build


pages:
    extends: .release
    
    variables:
        pages: &pages .staging/pages
    
    script:
      - mkdir -p ${pages}/documentation/
      - cp doc/homepage/* ${pages}/
      - cp doc/documentation/* ${pages}/documentation/
    
    publish: *pages # No trailing slash.
    
    artifacts:
        paths:
          - *pages


release:gitlab:
    extends: .release
    
    image: registry.gitlab.com/gitlab-org/release-cli:latest
    
    before_script: []
    
    script:
      - echo Creating new release...
    
    release:
        tag_name: ${CI_COMMIT_TAG}
        description: ${CI_COMMIT_TAG}