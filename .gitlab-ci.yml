include:
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml


stages:
  - build
  - test
  - publish
  - deploy
  - release


variables:
    PIP_ROOT_USER_ACTION: ignore  # Ignore pip warning when running as root.
    gitlabPypiUrl: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi


default:
    image: python:3.11.6-alpine3.18
    
    before_script:
      - apk add --no-cache git
      - pip install --no-cache-dir pdm
      - pdm install --plugins
    
    interruptible: true



# 
# Job templates.
#---------------------------------------------------------------------------------------------------
.releaseOnly:
    # Only run release jobs on tag pipelines.
    
    rules:
      - if: $CI_COMMIT_TAG


.includedAnalyzers: &includedAnalyzers
    # Run analyzers on all pipelines.
    # Use YAML anchors because `extends` is already used in the base job.
    
    rules:
      - when: on_success
    
    before_script: []



# 
# Build stage.
#---------------------------------------------------------------------------------------------------
package:
    # Build main package using PDM.
    
    stage: build
    
    script:
      - pdm build
      
      # Get data for link in GitLab release.
      - cd .staging/dist/
      - printf 'wheelName=%s\n' *.whl >> ../package.env
      - echo wheelHash=$(sha256sum *.whl | cut -d ' ' -f 1 ) >> ../package.env
      - printf 'sdistName=%s\n' *.tar.gz >> ../package.env
      - echo sdistHash=$(sha256sum *.tar.gz | cut -d ' ' -f 1 ) >> ../package.env
    
    artifacts:
        paths:
          - .staging/dist/
        reports:
            dotenv: .staging/package.env


pages:build:
    # Build documentation using TODO.
    
    stage: build
    
    variables:
        pages: &pages .staging/pages
    
    script:
      - mkdir -p ${pages}/documentation/
      - cp doc/homepage/* ${pages}/
      - cp doc/documentation/* ${pages}/documentation/
    
    artifacts:
        paths:
          - *pages



# 
# Test stage.
#---------------------------------------------------------------------------------------------------
test:
    # Run tests on main package.
    
    stage: test
    
    script:
      - pdm sync
      - pdm test
    
    coverage: /^TOTAL.+?(\d+(?:\.\d+)?\%)$/
    artifacts:
        reports:
            coverage_report:
                coverage_format: cobertura
                path: .staging/coverage.xml


semgrep-sast:
    # Analyze Python code using Semgrep.
    
    <<: *includedAnalyzers


secret_detection:
    # Scan repository for secrets.
    
    <<: *includedAnalyzers
    
    variables:
        SECRET_DETECTION_HISTORIC_SCAN: 'true'



# 
# Publish stage.
#---------------------------------------------------------------------------------------------------
package:gitlab:
    # Publish main package to project's package repository.
    
    extends: .releaseOnly
    stage: publish
    
    variables:
        PDM_PUBLISH_REPO: ${gitlabPypiUrl}
        PDM_PUBLISH_USERNAME: gitlab-ci-token
        PDM_PUBLISH_PASSWORD: ${CI_JOB_TOKEN}
    
    script:
      - pdm publish --no-build


package:pypi:
    # Publish main package to PyPI.
    
    extends: .releaseOnly
    stage: publish
    
    variables:
        PDM_PUBLISH_USERNAME: __token__
        PDM_PUBLISH_PASSWORD: ${PYPI_API_TOKEN}
    
    script:
      - pdm publish --no-build



# 
# Deploy stage.
#---------------------------------------------------------------------------------------------------
pages:
    # Trigger deployment to GitLab Pages.
    
    extends: .releaseOnly
    stage: deploy
    
    needs: [ pages:build ]
    
    environment:
        name: pages
        url: ${CI_PAGES_URL}
    
    script:
      - echo Deploying to GitLab Pages...
    
    publish: *pages # No trailing slash.
    artifacts:
        paths:
          - *pages



# 
# Release stage.
#---------------------------------------------------------------------------------------------------
release:gitlab:
    # Create GitLab release as last step in the pipeline.
    
    extends: .releaseOnly
    stage: release
    
    image: registry.gitlab.com/gitlab-org/release-cli:latest
    
    before_script: []
    
    script:
      - echo Creating new release...
    
    release:
        tag_name: ${CI_COMMIT_TAG}
        description: ${CI_COMMIT_TAG}
        assets:
            links:
              - name: Documentation
                url: ${CI_PAGES_URL}
              
              - name: Package on PyPI
                url: https://pypi.org/project/marcelotsvaz-python-project-template/${CI_COMMIT_TAG}/
              
              - name: Wheel
                url: ${gitlabPypiUrl}/files/${wheelHash}/${wheelName}
                filepath: /${wheelName}
                link_type: package
              
              - name: Source Distribution
                url: ${gitlabPypiUrl}/files/${sdistHash}/${sdistName}
                filepath: /${sdistName}
                link_type: package